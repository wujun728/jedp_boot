<!DOCTYPE table SYSTEM "../config/table-config-1.0.dtd">
<table sqlname="wk_mfs_repay_info" physicalName="wk_mfs_repay_info" remark="还款明细" ordinalMaxPosition="51" ordinalEffectiveDay="20191010">
    <column name="TERM_NO" javatype="Integer" jdbctype="INTEGER"/>

    <!--  特殊字符说明 &lt;&gt; <> -->
    <!-- baseSql option中 select * 会自动替换为 include -->
    <sql id="Base_Column_List">
        TERM_NO,DZ_STS,EVENT,ORG_NO,SEQ_NO 
        ,DATA_ID,FUND_NO,LOAN_ID,PROJNO,TX_DATE 
        ,CUR_DATE,DATA_STS,DEDU_WAY,SUMMARY,TRAN_DATE 
        ,TRAN_TIME,DBBANKNAME,DBACCOUNTNAME,DBBANKACCOUNT,PARTNER_LOAN_ID 
        ,BRE_CUT,INT_AMT,INTE_CUT,PRIN_AMT
        ,EXP_FINTE,TOTAL_AMT,FREE_FINTE,INCOME_AMT,CHARGES_AMT 
        ,FUND_FEE_AMT,OVERDUE_AMT,PNLT_INT_AMT,SERVICE_AMT,INT_REDUCED_AMT 
        ,PNLT_REDUCED_AMT,REPAY_VIOLATE_AMT,REFUND_VIOLATE_AMT,CHARGES_REDUCED_AMT,FUND_FEE_REDUCED_AMT 
        ,OVERDUE_REDUCED_AMT,SERVICE_REDUCED_AMT,REPAY_VIOLATE_REDUCED_AMT,REFUND_VIOLATE_REDUCED_AMT,ABS_SYNC_DATE,PRODUCT_ID,PRODUCT_NAME
        ,CHANGE_DATE ,TRUST_INT_AMT_ACC ,TRUST_PNLT_INT_AMT_ACC ,TRUST_BRT_AMT_ACC ,SERVICE_FEE_AMT
    </sql>

    <!-- baseSql option中 select wk.* 会自动替换为 include -->
    <sql id="Base_WK_Column_List">
        wk.TERM_NO,wk.DZ_STS,wk.EVENT,wk.ORG_NO,wk.SEQ_NO 
        ,wk.DATA_ID,wk.FUND_NO,wk.LOAN_ID,wk.PROJNO,wk.TX_DATE 
        ,wk.CUR_DATE,wk.DATA_STS,wk.DEDU_WAY,wk.SUMMARY,wk.TRAN_DATE 
        ,wk.TRAN_TIME,wk.DBBANKNAME,wk.DBACCOUNTNAME,wk.DBBANKACCOUNT,wk.PARTNER_LOAN_ID 
        ,wk.BRE_CUT,wk.INT_AMT,wk.INTE_CUT,wk.PRIN_AMT
        ,wk.EXP_FINTE,wk.TOTAL_AMT,wk.FREE_FINTE,wk.INCOME_AMT,wk.CHARGES_AMT 
        ,wk.FUND_FEE_AMT,wk.OVERDUE_AMT,wk.PNLT_INT_AMT,wk.SERVICE_AMT,wk.INT_REDUCED_AMT 
        ,wk.PNLT_REDUCED_AMT,wk.REPAY_VIOLATE_AMT,wk.REFUND_VIOLATE_AMT,wk.CHARGES_REDUCED_AMT,wk.FUND_FEE_REDUCED_AMT 
        ,wk.OVERDUE_REDUCED_AMT,wk.SERVICE_REDUCED_AMT,wk.REPAY_VIOLATE_REDUCED_AMT,wk.REFUND_VIOLATE_REDUCED_AMT,#{syncDate,jdbcType=DATE} as ABS_SYNC_DATE
        ,wk.PRODUCT_ID,wk.PRODUCT_NAME
        ,wk.CHANGE_DATE ,wk.TRUST_INT_AMT_ACC ,wk.TRUST_PNLT_INT_AMT_ACC ,wk.TRUST_BRT_AMT_ACC ,wk.SERVICE_FEE_AMT
    </sql>

    <operation name="insert" paramtype="object" remark="插入表:wk_mfs_repay_info" >
        <![CDATA[
            INSERT INTO wk_mfs_repay_info(
                    TERM_NO
                    ,PRODUCT_ID
                    ,PRODUCT_NAME
                    ,DZ_STS
                    ,EVENT
                    ,ORG_NO
                    ,SEQ_NO
                    ,DATA_ID
                    ,FUND_NO
                    ,LOAN_ID
                    ,PROJNO
                    ,TX_DATE
                    ,CUR_DATE
                    ,DATA_STS
                    ,DEDU_WAY
                    ,SUMMARY
                    ,TRAN_DATE
                    ,TRAN_TIME
                    ,DBBANKNAME
                    ,DBACCOUNTNAME
                    ,DBBANKACCOUNT
                    ,PARTNER_LOAN_ID
                    ,ABS_SYNC_DATE
                    ,BRE_CUT
                    ,INT_AMT
                    ,INTE_CUT
                    ,PRIN_AMT
                    ,EXP_FINTE
                    ,TOTAL_AMT
                    ,FREE_FINTE
                    ,INCOME_AMT
                    ,CHARGES_AMT
                    ,FUND_FEE_AMT
                    ,OVERDUE_AMT
                    ,PNLT_INT_AMT
                    ,SERVICE_AMT
                    ,INT_REDUCED_AMT
                    ,PNLT_REDUCED_AMT
                    ,REPAY_VIOLATE_AMT
                    ,REFUND_VIOLATE_AMT
                    ,CHARGES_REDUCED_AMT
                    ,FUND_FEE_REDUCED_AMT
                    ,OVERDUE_REDUCED_AMT
                    ,SERVICE_REDUCED_AMT
                    ,REPAY_VIOLATE_REDUCED_AMT
                    ,REFUND_VIOLATE_REDUCED_AMT
                    ,CHANGE_DATE ,TRUST_INT_AMT_ACC ,TRUST_PNLT_INT_AMT_ACC ,TRUST_BRT_AMT_ACC ,SERVICE_FEE_AMT
            )VALUES(
                      #{termNo,jdbcType=DECIMAL}
                    ,  #{productId,jdbcType=VARCHAR}
                    ,  #{productName,jdbcType=VARCHAR}
                    ,  #{dzSts,jdbcType=VARCHAR}
                    ,  #{event,jdbcType=VARCHAR}
                    ,  #{orgNo,jdbcType=VARCHAR}
                    ,  #{seqNo,jdbcType=VARCHAR}
                    ,  #{dataId,jdbcType=VARCHAR}
                    ,  #{fundNo,jdbcType=VARCHAR}
                    ,  #{loanId,jdbcType=VARCHAR}
                    ,  #{projno,jdbcType=VARCHAR}
                    ,  #{txDate,jdbcType=VARCHAR}
                    ,  #{curDate,jdbcType=VARCHAR}
                    ,  #{dataSts,jdbcType=VARCHAR}
                    ,  #{deduWay,jdbcType=VARCHAR}
                    ,  #{summary,jdbcType=VARCHAR}
                    ,  #{tranDate,jdbcType=VARCHAR}
                    ,  #{tranTime,jdbcType=VARCHAR}
                    ,  #{dbbankname,jdbcType=VARCHAR}
                    ,  #{dbaccountname,jdbcType=VARCHAR}
                    ,  #{dbbankaccount,jdbcType=VARCHAR}
                    ,  #{partnerLoanId,jdbcType=VARCHAR}
                    ,  #{absSyncDate,jdbcType=DATE}
                    ,  #{breCut,jdbcType=DECIMAL}
                    ,  #{intAmt,jdbcType=DECIMAL}
                    ,  #{inteCut,jdbcType=DECIMAL}
                    ,  #{prinAmt,jdbcType=DECIMAL}
                    ,  #{expFinte,jdbcType=DECIMAL}
                    ,  #{totalAmt,jdbcType=DECIMAL}
                    ,  #{freeFinte,jdbcType=DECIMAL}
                    ,  #{incomeAmt,jdbcType=DECIMAL}
                    ,  #{chargesAmt,jdbcType=DECIMAL}
                    ,  #{fundFeeAmt,jdbcType=DECIMAL}
                    ,  #{overdueAmt,jdbcType=DECIMAL}
                    ,  #{pnltIntAmt,jdbcType=DECIMAL}
                    ,  #{serviceAmt,jdbcType=DECIMAL}
                    ,  #{intReducedAmt,jdbcType=DECIMAL}
                    ,  #{pnltReducedAmt,jdbcType=DECIMAL}
                    ,  #{repayViolateAmt,jdbcType=DECIMAL}
                    ,  #{refundViolateAmt,jdbcType=DECIMAL}
                    ,  #{chargesReducedAmt,jdbcType=DECIMAL}
                    ,  #{fundFeeReducedAmt,jdbcType=DECIMAL}
                    ,  #{overdueReducedAmt,jdbcType=DECIMAL}
                    ,  #{serviceReducedAmt,jdbcType=DECIMAL}
                    ,  #{repayViolateReducedAmt,jdbcType=DECIMAL}
                    ,  #{refundViolateReducedAmt,jdbcType=DECIMAL}

                    ,  #{changeDate,jdbcType=VARCHAR}
                    ,  #{trustIntAmtAcc,jdbcType=DECIMAL}
                    ,  #{trustPnltIntAmtAcc,jdbcType=DECIMAL}
                    ,  #{trustBrtAmtAcc,jdbcType=DECIMAL}
                    ,  #{serviceFeeAmt,jdbcType=DECIMAL}
            )
            ]]>
    </operation>
    <operation name="updateData">
        truncate table wk_mfs_repay_info
    </operation>
    <operation name="insertSyncIncrement" multiplicity="one" paramtype="primitive" remark="根据会计时间同步还款明细表">
        <extraparams>
            <param name="wkxwDbName" javatype="String"/>
            <param name="wkxwSynonymPre" javatype="String"/>
        </extraparams>
            INSERT INTO wk_mfs_repay_info (<include refid="Base_Column_List"/>)
            SELECT
                <include refid="Base_WK_Column_List"/>
            FROM
                ${wkxwDbName}${wkxwSynonymPre}mfs_repay_info@wkxw_dlk wk
            WHERE
                    CUR_DATE  =  #{curDate,jdbcType=VARCHAR}
                AND ORG_NO    =  #{orgNo,jdbcType=VARCHAR}
                AND wk.PROJNO in
                <foreach collection="lists" item="projNo" separator=","  open="(" close=")">
                    #{projNo,jdbcType=VARCHAR}
                </foreach>
    </operation>

    <operation name="insertSyncAll" multiplicity="one" paramtype="primitive" remark="同步全量还款明细表">
        <extraparams>
            <param name="wkxwDbName" javatype="String"/>
            <param name="wkxwSynonymPre" javatype="String"/>
        </extraparams>
            INSERT INTO wk_mfs_repay_info (<include refid="Base_Column_List"/>)
            SELECT
                <include refid="Base_WK_Column_List"/>
            FROM
                ${wkxwDbName}${wkxwSynonymPre}mfs_repay_info@wkxw_dlk wk
            WHERE
                ORG_NO    =  #{orgNo,jdbcType=VARCHAR}
            AND wk.PROJNO in
            <foreach collection="lists" item="projNo" separator=","  open="(" close=")">
                #{projNo,jdbcType=VARCHAR}
            </foreach>
    </operation>

    <operation name="getByLoanId" multiplicity="many" paramtype="primitive" remark="查询待执行的任务">
        SELECT
        *
        FROM
        wk_mfs_repay_info
        WHERE
        <!-- 看是否需要根据syncDate分区，不需要的话，将这行放到后面 -->
        ABS_SYNC_DATE = #{syncDate,jdbcType=DATE}
        AND LOAN_ID = #{loanId,jdbcType=VARCHAR}
        AND ORG_NO = #{orgNo,jdbcType=VARCHAR}
    </operation>


    <operation name="queryStatRepayInfoForOrg" multiplicity="many" kvmap="true" mapK="PROJNO" mapV="INCOME_AMT"
               paramtype="primitive" remark="根据机构编号统计项目还款额合计">
        SELECT
        SUM(INCOME_AMT) INCOME_AMT, PROJNO
        FROM
        wk_mfs_repay_info
        WHERE
            ORG_NO = #{orgNo,jdbcType=VARCHAR}
        GROUP BY PROJNO
    </operation>

</table>
